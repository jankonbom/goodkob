<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Panel Admin Complet - DarkLabbb Shop</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <!-- Page de Connexion -->
    <div id="loginPage" class="login-page">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <h1>üîê Connexion Admin</h1>
                    <p>Acc√©dez au panel d'administration</p>
                </div>
                <form class="login-form" onsubmit="login(); return false;">
                    <div class="form-group">
                        <label for="username">Nom d'utilisateur</label>
                        <input type="text" id="username" class="form-control" placeholder="admin" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" class="form-control" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        <span class="btn-icon">üöÄ</span>
                        Se connecter
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Panel Admin (cach√© par d√©faut) -->
    <div id="adminPanel" class="admin-container" style="display: none;">
        <!-- Header Admin -->
        <header class="admin-header">
            <div class="header-content">
                <div class="header-left">
                    <div class="admin-logo">
                        <img src="https://i.imgur.com/2T05Hat.jpeg" alt="DarkLabbb Logo" class="admin-logo-img">
                    </div>
                    <h1>Panel Administration</h1>
                </div>
                <div class="header-right">
                    <button class="btn btn-secondary" onclick="loadArticles()">
                        <span class="btn-icon">üëÅÔ∏è</span>
                        Aper√ßu
                    </button>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <span class="btn-icon">‚ÜóÔ∏è</span>
                        D√©connexion
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Admin -->
        <nav class="admin-nav">
            <div class="nav-content">
                <button class="nav-item active" onclick="switchSection('articles')">
                    <span class="nav-icon">üìÑ</span>
                    <span class="nav-text">Articles</span>
                </button>
                <button class="nav-item" onclick="switchSection('categories')">
                    <span class="nav-icon">üìÅ</span>
                    <span class="nav-text">Cat√©gories</span>
                </button>
                <button class="nav-item" onclick="switchSection('info')">
                    <span class="nav-icon">‚ÑπÔ∏è</span>
                    <span class="nav-text">Informations</span>
                </button>
                <button class="nav-item" onclick="switchSection('command-messages')">
                    <span class="nav-icon">üí¨</span>
                    <span class="nav-text">Messages de Commande</span>
                </button>
                <button class="nav-item" onclick="switchSection('github-config')">
                    <span class="nav-icon">üîë</span>
                    <span class="nav-text">Token GitHub</span>
                </button>
                <button class="nav-item" onclick="switchSection('github-setup')">
                    <span class="nav-icon">‚öôÔ∏è</span>
                    <span class="nav-text">Config Token</span>
                </button>
            </div>
        </nav>

        <!-- Contenu Principal -->
        <main class="admin-main">
            <!-- Section Articles -->
            <section id="articles-section" class="admin-section active">
                <div class="section-header">
                    <h2>üìÑ Gestion des Articles</h2>
                    <p>Cr√©ez et g√©rez vos articles de vente</p>
                </div>
                <div class="section-content">
                    <div id="articlesContainer">
                        <!-- Contenu charg√© dynamiquement -->
                    </div>
                </div>
            </section>

            <!-- Section Cat√©gories -->
            <section id="categories-section" class="admin-section">
                <div class="section-header">
                    <h2>üìÅ Gestion des Cat√©gories</h2>
                    <p>Organisez vos produits par cat√©gories</p>
                </div>
                <div class="section-content">
                    <div id="categoriesContainer">
                        <!-- Contenu charg√© dynamiquement -->
                    </div>
                </div>
            </section>

            <!-- Section Informations -->
            <section id="info-section" class="admin-section">
                <div class="section-header">
                    <h2>‚ÑπÔ∏è Informations Syst√®me</h2>
                    <p>Statistiques et informations sur votre boutique</p>
                </div>
                <div class="section-content">
                    <div id="infoContainer">
                        <!-- Contenu charg√© dynamiquement -->
                    </div>
                </div>
            </section>

            <!-- Section Configuration GitHub -->
            <section id="github-config-section" class="admin-section">
                <div class="section-header">
                    <h2>üîë Configuration GitHub</h2>
                    <p>Configurez votre token GitHub pour l'upload automatique des vid√©os</p>
                </div>
                <div class="section-content">
                    <div class="github-config-container">
                        <div class="config-card">
                            <h3>üîê Token GitHub</h3>
                            <p>Votre token est actuellement configur√© avec localStorage. Il sera demand√© une seule fois par navigateur.</p>
                            
                            <div class="token-status">
                                <div class="status-indicator" id="tokenStatus">
                                    <span class="status-icon">‚ùì</span>
                                    <span class="status-text">V√©rification en cours...</span>
                                </div>
                            </div>
                            
                            <div class="token-actions">
                                <button class="btn btn-primary" onclick="testGitHubToken()">
                                    <span class="btn-icon">üß™</span>
                                    Tester le Token
                                </button>
                                <button class="btn btn-secondary" onclick="clearGitHubToken()">
                                    <span class="btn-icon">üóëÔ∏è</span>
                                    Effacer le Token
                                </button>
                                <button class="btn btn-success" onclick="showTokenInstructions()">
                                    <span class="btn-icon">üìã</span>
                                    Instructions
                                </button>
                            </div>
                            
                            <div class="token-info">
                                <h4>‚ÑπÔ∏è Comment √ßa marche :</h4>
                                <ul>
                                    <li>‚úÖ <strong>Premi√®re fois</strong> : Le site demande votre token</li>
                                    <li>‚úÖ <strong>Token sauvegard√©</strong> : Dans le navigateur (localStorage)</li>
                                    <li>‚úÖ <strong>Prochaines fois</strong> : Plus besoin de retaper</li>
                                    <li>‚úÖ <strong>Fonctionne partout</strong> : PC, mobile, tablet</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section Configuration Token Direct -->
            <section id="github-setup-section" class="admin-section">
                <div class="section-header">
                    <h2>‚öôÔ∏è Configuration Token Direct</h2>
                    <p>Ajoutez votre token GitHub directement dans cette interface</p>
                </div>
                <div class="section-content">
                    <div class="github-setup-container">
                        <div class="setup-card">
                            <h3>üîß Ajouter un Token GitHub</h3>
                            <p>Collez votre token GitHub ici pour l'activer imm√©diatement</p>
                            
                            <div class="token-input-section">
                                <label for="tokenInput">Token GitHub :</label>
                                <div class="token-input-group">
                                    <input type="password" id="tokenInput" placeholder="ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="token-input">
                                    <button class="btn btn-toggle" onclick="toggleTokenVisibility()">
                                        <span class="btn-icon">üëÅÔ∏è</span>
                                    </button>
                                </div>
                                <small class="input-hint">Votre token sera sauvegard√© localement dans le navigateur</small>
                            </div>
                            
                            <div class="setup-actions">
                                <button class="btn btn-primary" onclick="saveTokenDirectly()">
                                    <span class="btn-icon">üíæ</span>
                                    Sauvegarder le Token
                                </button>
                                <button class="btn btn-secondary" onclick="clearTokenInput()">
                                    <span class="btn-icon">üóëÔ∏è</span>
                                    Effacer
                                </button>
                                <button class="btn btn-info" onclick="generateNewToken()">
                                    <span class="btn-icon">üÜï</span>
                                    Cr√©er un Nouveau Token
                                </button>
                            </div>
                            
                            <div class="setup-status" id="setupStatus">
                                <div class="status-message">
                                    <span class="status-icon">‚ÑπÔ∏è</span>
                                    <span class="status-text">Pr√™t √† configurer votre token</span>
                                </div>
                            </div>
                            
                            <div class="setup-info">
                                <h4>üìã Instructions :</h4>
                                <ol>
                                    <li>Allez sur <a href="https://github.com/settings/tokens" target="_blank">GitHub Settings ‚Üí Tokens</a></li>
                                    <li>Cliquez sur "Generate new token (classic)"</li>
                                    <li>Nom : "Upload Videos"</li>
                                    <li>Permissions : cochez "repo" (Full control)</li>
                                    <li>Copiez le token (ghp_...)</li>
                                    <li>Collez-le dans le champ ci-dessus</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Section Messages de Commande -->
            <section id="command-messages-section" class="admin-section">
                <div class="section-header">
                    <h2>üí¨ Messages de Commande</h2>
                    <p>G√©rez les messages automatiques de commande</p>
                </div>
                <div class="section-content">
                    <div id="commandMessagesContainer">
                        <!-- Contenu charg√© dynamiquement -->
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Ajout/Modification d'Article -->
    <div id="articleModal" class="modal" style="display: none;" oncontextmenu="return false;">
        <div class="modal-content" oncontextmenu="return false;">
            <div class="modal-header">
                <h3 id="modalTitle">Ajouter un Article</h3>
                <button class="modal-close" onclick="closeModal()" oncontextmenu="return false;">‚úï</button>
            </div>
            
            <form id="articleForm" onsubmit="saveArticle(event)" oncontextmenu="return false;">
                <!-- Informations de base -->
                <div class="form-group">
                    <label for="articleTitle">Titre de l'article *</label>
                    <input type="text" id="articleTitle" name="title" class="form-control" placeholder="Nom du produit" required>
                </div>

                <div class="form-group">
                    <label for="articleDescription">Description *</label>
                    <textarea id="articleDescription" name="description" class="form-control" rows="4" placeholder="Description d√©taill√©e du produit" required></textarea>
                </div>

                <div class="form-group">
                    <label for="articlePrice">Prix (‚Ç¨) *</label>
                    <input type="number" id="articlePrice" name="price" class="form-control" step="0.01" min="0" placeholder="0.00" required>
                </div>

                <div class="form-group">
                    <label for="stockStatus">Statut de Stock</label>
                    <select id="stockStatus" name="stock_status" class="form-control">
                        <option value="EN_STOCK">EN STOCK</option>
                        <option value="RUPTURE">RUPTURE DE STOCK</option>
                        <option value="LIMITE">STOCK LIMIT√â</option>
                    </select>
                </div>

                <!-- Zone de Drag & Drop pour l'image/vid√©o -->
                <div class="form-group">
                    <label>Image/Vid√©o de l'article *</label>
                    
                    <!-- Version Mobile -->
                    <div id="mobileUpload" class="mobile-upload" style="display: none;">
                        <input type="file" id="mobileMediaInput" accept="image/*,video/*" style="width: 100%; padding: 15px; border: 2px solid #007bff; border-radius: 8px; font-size: 16px;">
                    </div>
                    
                    <!-- Version PC -->
                    <div id="pcUpload" class="pc-upload">
                        <div class="media-upload-zone" id="mediaUploadZone">
                            <div class="upload-content">
                                <span class="upload-icon">üì∑</span>
                                <p>Glissez-d√©posez une image ou vid√©o ici</p>
                                <p class="upload-hint">Ou cliquez pour choisir un fichier</p>
                                <p class="upload-formats">Formats: JPG, PNG, GIF, MP4, WEBM, MOV, AVI, MKV</p>
                            </div>
                            <input type="file" id="mediaInput" accept="image/*,video/*" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10;">
                        </div>
                    </div>
                    <div class="media-preview" id="mediaPreview" style="display: none;">
                        <div class="preview-container">
                            <img id="previewImg" src="" alt="Aper√ßu" style="display: none; max-width: 200px; max-height: 200px; border-radius: 8px;">
                            <video id="previewVideo" src="" controls style="display: none; max-width: 200px; max-height: 200px; border-radius: 8px;"></video>
                            <button type="button" class="remove-media" id="removeMedia">‚úï</button>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">
                        <span class="btn-icon">‚ùå</span>
                        Annuler
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <span class="btn-icon">üíæ</span>
                        Sauvegarder
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Panel Debug Mobile Safari -->
    <script>
        // Panel debug sp√©cialement pour Safari mobile
        if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
            // Cr√©er le bouton debug
            const debugBtn = document.createElement('button');
            debugBtn.innerHTML = 'üîç DEBUG UPLOAD';
            debugBtn.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: bold;
                cursor: pointer;
                box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                transition: all 0.3s ease;
            `;
            
            debugBtn.addEventListener('mouseover', function() {
                this.style.transform = 'scale(1.05)';
            });
            
            debugBtn.addEventListener('mouseout', function() {
                this.style.transform = 'scale(1)';
            });
            
            document.body.appendChild(debugBtn);
            
            // Panel debug
            let debugPanelVisible = false;
            let debugPanel = null;
            
            debugBtn.addEventListener('click', function() {
                if (!debugPanelVisible) {
                    createDebugPanel();
                } else {
                    closeDebugPanel();
                }
            });
            
            function createDebugPanel() {
                debugPanel = document.createElement('div');
                debugPanel.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(135deg, #1e3c72, #2a5298);
                    z-index: 10001;
                    color: white;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    overflow-y: auto;
                `;
                
                debugPanel.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid rgba(255,255,255,0.2); padding-bottom: 15px;">
                            <h2 style="margin: 0; color: #4ecdc4;">üîç DEBUG UPLOAD SAFARI</h2>
                            <button onclick="closeDebugPanel()" style="background: #ff6b6b; color: white; border: none; padding: 8px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;">‚úï FERMER</button>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <h3 style="color: #4ecdc4; margin-top: 0;">üì± INFOS MOBILE</h3>
                                <div id="mobileInfo"></div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <h3 style="color: #4ecdc4; margin-top: 0;">üîë TOKEN STATUS</h3>
                                <div id="tokenInfo"></div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h3 style="color: #4ecdc4; margin-top: 0;">üìä UPLOAD STATUS</h3>
                            <div id="uploadStatus">
                                <div style="color: #ffa500;">‚è≥ En attente d'upload...</div>
                            </div>
                        </div>
                        
                        <div style="background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; height: 300px; overflow-y: auto;">
                            <h3 style="color: #4ecdc4; margin-top: 0;">üìù LOGS EN TEMPS R√âEL</h3>
                            <div id="debugLogs" style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;"></div>
                        </div>
                        
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="clearDebugLogs()" style="background: #ffa500; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; margin-right: 10px;">üóëÔ∏è CLEAR LOGS</button>
                            <button onclick="testUpload()" style="background: #4ecdc4; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer;">üß™ TEST UPLOAD</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(debugPanel);
                debugPanelVisible = true;
                
                // Initialiser les infos
                updateMobileInfo();
                updateTokenInfo();
                
                // Intercepter les logs
                interceptConsoleLogs();
            }
            
            function closeDebugPanel() {
                if (debugPanel) {
                    debugPanel.remove();
                    debugPanelVisible = false;
                }
            }
            
            function updateMobileInfo() {
                const mobileInfo = document.getElementById('mobileInfo');
                if (mobileInfo) {
                    mobileInfo.innerHTML = `
                        <div><strong>Navigateur:</strong> ${navigator.userAgent.split(' ')[0]}</div>
                        <div><strong>√âcran:</strong> ${window.innerWidth}x${window.innerHeight}</div>
                        <div><strong>Touch:</strong> ${('ontouchstart' in window) ? '‚úÖ' : '‚ùå'}</div>
                        <div><strong>Online:</strong> ${navigator.onLine ? '‚úÖ' : '‚ùå'}</div>
                        <div><strong>User Agent:</strong> ${navigator.userAgent.substring(0, 50)}...</div>
                    `;
                }
            }
            
            function updateTokenInfo() {
                const tokenInfo = document.getElementById('tokenInfo');
                if (tokenInfo) {
                    const token = localStorage.getItem('github_token_imageforko');
                    if (token) {
                        tokenInfo.innerHTML = `
                            <div style="color: #4ecdc4;">‚úÖ Token configur√©</div>
                            <div><strong>Format:</strong> ${token.substring(0, 8)}...</div>
                            <div><strong>Longueur:</strong> ${token.length} caract√®res</div>
                        `;
                    } else {
                        tokenInfo.innerHTML = `
                            <div style="color: #ff6b6b;">‚ùå Aucun token</div>
                            <div>Configurez le token d'abord</div>
                        `;
                    }
                }
            }
            
            function interceptConsoleLogs() {
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                
                function addDebugLog(message, type = 'log') {
                    const debugLogs = document.getElementById('debugLogs');
                    if (debugLogs) {
                        const timestamp = new Date().toLocaleTimeString();
                        const color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffa500' : type === 'success' ? '#4ecdc4' : '#ffffff';
                        const icon = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : type === 'success' ? '‚úÖ' : 'üìù';
                        
                        debugLogs.innerHTML += `
                            <div style="color: ${color}; margin: 3px 0; border-left: 3px solid ${color}; padding-left: 8px;">
                                <span style="color: #888;">[${timestamp}]</span> ${icon} ${message}
                            </div>
                        `;
                        debugLogs.scrollTop = debugLogs.scrollHeight;
                    }
                }
                
                console.log = function(...args) {
                    originalLog.apply(console, args);
                    addDebugLog(args.join(' '), 'log');
                };
                
                console.error = function(...args) {
                    originalError.apply(console, args);
                    addDebugLog(args.join(' '), 'error');
                };
                
                console.warn = function(...args) {
                    originalWarn.apply(console, args);
                    addDebugLog(args.join(' '), 'warn');
                };
                
                // Logs de d√©marrage
                addDebugLog('üîç Panel debug Safari activ√©', 'success');
                addDebugLog(`üì± D√©tection: ${navigator.userAgent.split(' ')[0]}`, 'log');
                addDebugLog(`üìè R√©solution: ${window.innerWidth}x${window.innerHeight}`, 'log');
            }
            
            // Fonctions globales pour le debug
            window.closeDebugPanel = closeDebugPanel;
            window.clearDebugLogs = function() {
                const debugLogs = document.getElementById('debugLogs');
                if (debugLogs) {
                    debugLogs.innerHTML = '';
                }
            };
            window.testUpload = function() {
                const debugLogs = document.getElementById('debugLogs');
                if (debugLogs) {
                    debugLogs.innerHTML += '<div style="color: #4ecdc4; margin: 3px 0;">üß™ Test d\'upload lanc√©...</div>';
                }
                console.log('üß™ Test d\'upload manuel');
            };
            
            // Intercepter les √©v√©nements d'upload
            document.addEventListener('DOMContentLoaded', function() {
                // Intercepter les s√©lections de fichiers
                const originalAddEventListener = EventTarget.prototype.addEventListener;
                EventTarget.prototype.addEventListener = function(type, listener, options) {
                    if (type === 'change' && this.type === 'file') {
                        const wrappedListener = function(event) {
                            console.log('üìÅ Fichier s√©lectionn√©:', event.target.files[0]?.name);
                            updateUploadStatus('üìÅ Fichier s√©lectionn√©: ' + event.target.files[0]?.name);
                            return listener.call(this, event);
                        };
                        return originalAddEventListener.call(this, type, wrappedListener, options);
                    }
                    return originalAddEventListener.call(this, type, listener, options);
                };
            });
            
            function updateUploadStatus(message) {
                const uploadStatus = document.getElementById('uploadStatus');
                if (uploadStatus) {
                    uploadStatus.innerHTML = `<div style="color: #4ecdc4;">${message}</div>`;
                }
            }
            
            // Intercepter les appels d'upload
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                console.log('üåê Appel r√©seau:', args[0]);
                updateUploadStatus('üåê Upload en cours vers GitHub...');
                
                return originalFetch.apply(this, args)
                    .then(response => {
                        console.log('üìä R√©ponse r√©seau:', response.status);
                        if (response.ok) {
                            updateUploadStatus('‚úÖ Upload r√©ussi !');
                        } else {
                            updateUploadStatus('‚ùå Erreur upload: ' + response.status);
                        }
                        return response;
                    })
                    .catch(error => {
                        console.error('‚ùå Erreur r√©seau:', error);
                        updateUploadStatus('‚ùå Erreur r√©seau: ' + error.message);
                        throw error;
                    });
            };
        }
    </script>

    <!-- Scripts -->
    <script src="github-storage.js"></script>
    <script src="admin-script.js"></script>
</body>
</html>
